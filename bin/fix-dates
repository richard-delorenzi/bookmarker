#!/usr/bin/python3

import re
import json
import urllib.request
import requests

urlBase= "http://mycouchdb:80/bookmarks/"


def is_dateFormat(data):
    return re.match (
	"\d{4}\-\d{2}\-\d{2}T\d{2}:\d{2}:\d{2}(\.\d*)?Z",
        data )

def pageContent(page):
    return urllib.request.urlopen(
        page
    ).read().decode("utf-8")   

def pageData(page):
    rawdata=pageContent(
        page
    )
    return json.loads(rawdata)

def candidateRows():
    data=pageData(
        urlBase+ "_design/design/_view/webmarks-by-date"
    )
    return data["rows"]

    
def IDs():
    for row in candidateRows():
        date = row["key"][0]
        id = row["id"]
        if not is_dateFormat(date):
            yield (id)

def docWithId(id):
    return pageData(id)

def putDoc(id,doc):
    print(id)
    doc=json.dumps(doc)
    status = requests.put(urlBase+ "/" +id, data=doc)
    print(status)

for id in IDs():
    doc= docWithId(urlBase +id)
    rev= doc["_rev"]
    fixedDate=doc["created_at"]+"Z"
    id= doc["_id"]
    doc["created_at"]=fixedDate
    putDoc( id, doc )
